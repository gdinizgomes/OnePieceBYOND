<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const BYOND_REF = "{{BYOND_REF}}"; 
        window.onerror = function(message, source, lineno, colno, error) {
            let errorBox = document.getElementById('error-debug');
            if (!errorBox) {
                errorBox = document.createElement('div');
                errorBox.id = 'error-debug';
                errorBox.style.cssText = 'position:fixed; top:0; left:0; width:100%; background:rgba(200,0,0,0.9); color:white; z-index:9999; padding:10px; font-family:monospace; pointer-events:none;';
                document.body.appendChild(errorBox);
            }
            errorBox.innerHTML += "ERRO JS: " + message + " em linha " + lineno + "<br>";
        };
    </script>
    <style>
        body { margin: 0; overflow: hidden; user-select: none; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        .name-label {
            position: absolute; 
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            pointer-events: none; 
            white-space: nowrap;
            transform: translate(-50%, -100%); 
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .mini-hp-bg {
            width: 100%; height: 4px; background: #333; margin-top: 2px; border-radius: 2px; overflow: hidden;
        }
        .mini-hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.2s; }

        .dmg-popup {
            position: absolute; color: #ff3333; font-weight: bold; font-size: 20px;
            text-shadow: 2px 2px 0px #000; pointer-events: none;
            animation: floatUp 1s ease-out forwards; z-index: 9000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        .char-info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; color: white; border: 2px solid #d4af37; pointer-events: auto; min-width: 200px; }
        .bar-container { width: 100%; height: 10px; background: #333; margin-top: 2px; overflow: hidden; border: 1px solid #555; }
        .hp-bar { width: 100%; height: 100%; background: #e74c3c; transition: width 0.2s; }
        .en-bar { width: 100%; height: 100%; background: #3498db; transition: width 0.2s; }
        .xp-bar { width: 0%; height: 100%; background: #9b59b6; transition: width 0.2s; } 

        #target-window {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 8px; 
            color: white; border: 2px solid #e74c3c; pointer-events: none; 
            min-width: 250px; display: none; box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
        }
        #target-name { font-size: 16px; font-weight: bold; text-align: center; margin-bottom: 5px; color: #fff; text-shadow: 1px 1px 0 #000; }
        .target-hp-bg { width: 100%; height: 15px; background: #333; border: 1px solid #555; border-radius: 3px; position: relative; }
        .target-hp-fill { height: 100%; background: #e74c3c; width: 50%; transition: width 0.1s; }
        .target-hp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; line-height: 15px; font-weight: bold; text-shadow: 1px 1px 0 #000; }

        #controls-help {
            position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.5); color: #ccc;
            padding: 10px; border-radius: 5px; font-size: 11px; font-family: monospace; pointer-events: auto;
        }

        /* --- STATUS WINDOW --- */
        #stat-window {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 480px; background: rgba(20, 20, 30, 0.95); color: white;
            border: 2px solid #d4af37; border-radius: 10px; padding: 20px;
            display: none; pointer-events: auto; z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .stat-header { display: flex; justify-content: space-between; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 10px; }
        .stat-col { width: 45%; }
        
        .equip-slots { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }
        .equip-slot {
            width: 50px; height: 50px; border: 1px solid #777; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; position: relative;
        }
        .equip-slot label { position: absolute; font-size: 9px; top: -12px; color: #aaa; width: 100%; text-align: center; }
        .equip-icon { max-width: 90%; max-height: 90%; object-fit: contain; image-rendering: pixelated; }

        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 13px; }
        .stat-btn {
            background: #d4af37; color: black; border: none; border-radius: 4px;
            width: 20px; height: 20px; font-weight: bold; cursor: pointer; font-size: 12px; margin-left: 5px;
        }

        /* --- HABILIDADES WINDOW --- */
        #skills-window {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 500px; background: rgba(20, 20, 30, 0.95); color: white;
            border: 2px solid #9b59b6; border-radius: 10px; padding: 0;
            display: none; pointer-events: auto; z-index: 110; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            flex-direction: column; max-height: 80vh;
        }
        .skills-header { padding: 15px; border-bottom: 1px solid #555; text-align: center; font-weight: bold; color: #9b59b6; letter-spacing: 1px; }
        .tabs-header { display: flex; background: rgba(0,0,0,0.3); }
        .tab-btn { flex: 1; padding: 12px 0; background: none; border: none; border-bottom: 2px solid transparent; color: #aaa; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { color: #9b59b6; border-bottom: 2px solid #9b59b6; background: rgba(155, 89, 182, 0.1); }
        .tab-btn:disabled { color: #444; cursor: not-allowed; }
        
        .tab-content { padding: 15px; height: 320px; display: none; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        /* Custom Scrollbar para as Abas */
        .tab-content::-webkit-scrollbar { width: 8px; }
        .tab-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        .tab-content::-webkit-scrollbar-thumb { background: #9b59b6; border-radius: 4px; }
        .tab-content::-webkit-scrollbar-thumb:hover { background: #8e44ad; }
        
        .skill-card { background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; align-items: center; border: 1px solid #444; }
        .skill-icon { width: 44px; height: 44px; background: #222; border-radius: 5px; display: flex; justify-content: center; align-items: center; font-size: 24px; margin-right: 15px; border: 1px solid #555; box-shadow: inset 0 0 10px #000; }
        .skill-info { flex: 1; }
        .skill-name { font-weight: bold; font-size: 15px; margin-bottom: 2px; color: #f1c40f; }
        .skill-desc { font-size: 11px; color: #ccc; margin-bottom: 8px; line-height: 1.2; }
        .skill-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .skill-bar-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s; }
        .skill-lvl { font-weight: bold; font-size: 16px; color: white; width: 50px; text-align: right; margin-left: 10px; }
        
        /* --- INVENT√ÅRIO GRID --- */
        #inventory-window {
            position: absolute; top: 50%; right: 10%; transform: translateY(-50%); width: 320px; background: rgba(20, 20, 30, 0.95);
            border: 2px solid #3498db; border-radius: 10px; padding: 15px;
            display: none; pointer-events: auto; color: white; z-index: 100; flex-direction: column;
        }
        #inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .inv-slot {
            width: 60px; height: 60px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px;
            position: relative; cursor: pointer; transition: border-color 0.2s; display: flex; justify-content: center; align-items: center;
        }
        .inv-slot:hover { border-color: #f1c40f; }
        .inv-icon { max-width: 90%; max-height: 90%; object-fit: contain; image-rendering: pixelated; }
        .inv-qty { position: absolute; bottom: 2px; right: 4px; font-size: 12px; font-weight: bold; color: white; text-shadow: 1px 1px 0 #000; }
        .inv-actions { position: absolute; top: 100%; left: 0; width: 100%; background: #222; border: 1px solid #555; z-index: 10; display: none; flex-direction: column; }
        .inv-slot:hover .inv-actions { display: flex; }
        .action-btn { background: none; border: none; color: white; font-size: 10px; padding: 4px; cursor: pointer; text-align: center; border-bottom: 1px solid #444; }
        .action-btn:hover { background: #444; }
        .btn-trash { color: #e74c3c; }
        .btn-sell { color: #f1c40f; display: none; } 

        #shop-window {
            position: absolute; top: 50%; left: 10%; transform: translateY(-50%); width: 320px; background: rgba(30, 20, 10, 0.95);
            border: 2px solid #e67e22; border-radius: 10px; padding: 15px; display: none; pointer-events: auto; color: white; z-index: 100; flex-direction: column;
        }
        .shop-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); margin-bottom: 5px; padding: 5px; border-radius: 4px; }
        .shop-item img { width: 40px; height: 40px; image-rendering: pixelated; margin-right: 10px; object-fit: contain; background: rgba(0,0,0,0.3); border-radius: 4px; }
        .shop-details { flex-grow: 1; }
        .shop-name { font-weight: bold; font-size: 14px; }
        .shop-price { color: #f1c40f; font-size: 12px; }
        .btn-buy { background: #27ae60; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-buy:hover { background: #2ecc71; }

        #tooltip {
            position: absolute; background: rgba(0,0,0,0.9); border: 1px solid #aaa; color: #eee; padding: 8px; font-size: 12px; border-radius: 4px;
            pointer-events: none; display: none; z-index: 2000; max-width: 200px;
        }
        #tooltip strong { color: #f1c40f; display: block; margin-bottom: 3px; }
        #combat-log { position: absolute; bottom: 20px; right: 20px; width: 300px; height: 150px; background: rgba(0,0,0,0.5); color: #fff; font-size: 12px; overflow-y: auto; padding: 10px; border-radius: 5px; font-family: monospace; pointer-events: auto; }
        .log-hit { color: #e74c3c; font-weight: bold; } 
        #notif-area { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); text-align: center; }
        
        #faint-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(50, 0, 0, 0.6);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; pointer-events: none;
        }
        #interaction-hint {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: #f1c40f; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; display: none; pointer-events: none; border: 1px solid #f1c40f;
        }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="faint-overlay">
            <div style="font-size: 30px; color: #ff5555; font-weight: bold;">VOC√ä EST√Å DESMAIADO</div>
            <div id="faint-timer" style="font-size: 60px; color: white;">15</div>
        </div>

        <div id="interaction-hint">[X] Interagir</div>
        <div id="tooltip"></div>

        <div id="target-window">
            <div id="target-name">Nome do Alvo</div>
            <div class="target-hp-bg">
                <div id="target-hp-fill" class="target-hp-fill"></div>
                <div id="target-hp-text" class="target-hp-text">100/100</div>
            </div>
        </div>

        <div class="char-info">
            <div id="name-display" style="font-size: 18px; font-weight: bold;">Loading...</div>
            <div style="font-size: 12px; color: #aaa;">Lvl <span id="lvl-display">0</span></div>
            <div style="font-size:10px;">HP <span id="hp-text"></span></div> <div class="bar-container"><div id="hp-bar-fill" class="hp-bar"></div></div>
            <div style="font-size:10px;">Energy <span id="en-text"></span></div> <div class="bar-container"><div id="en-bar-fill" class="en-bar"></div></div>
            <div style="font-size:10px;">EXP</div> <div class="bar-container" style="height: 4px;"><div id="xp-bar-fill" class="xp-bar"></div></div>
            <div style="margin-top:5px; color:#f1c40f">üí∞ <span id="gold-display">0</span> Berries</div>
            <div style="margin-top:5px; font-size: 10px; color: #ccc;">[C] Status | [I] Mochila | [K] Habilidades | [TAB] Alvo</div>
        </div>

        <div id="controls-help">
            <strong>CONTROLES:</strong><br>
            [W,A,S,D] Mover<br>[SHIFT] Correr<br>[Espa√ßo] Pular<br>
            [A] Soco &nbsp; [S] Chute<br>[D] Espada [F] Arma<br>
            [R] Descansar<br>[C] Stats [I] Itens [K] Habilidades<br>[TAB] Alvo
        </div>

        <div id="stat-window">
            <div class="stat-header">
                <div>
                    <div style="font-size: 18px; font-weight: bold;" id="stat-name">Nome</div>
                    <div style="font-size: 12px; color: #aaa;" id="stat-class">Civil</div>
                    <div style="font-size: 12px; color: #f1c40f;" id="stat-title">Nenhum</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 24px; font-weight: bold;" id="stat-lvl">1</div>
                    <div style="font-size: 10px;">N√çVEL</div>
                </div>
            </div>

            <div style="display: flex; gap: 20px;">
                <div class="stat-col">
                    <div style="margin-bottom: 5px;"><strong>ATRIBUTOS</strong> (Pts: <span id="stat-points" style="color:#f1c40f">0</span>)</div>
                    <div class="stat-row"><span>FOR (For√ßa)</span> <div><span id="val-str">0</span> <button class="stat-btn" onclick="addStat('str')">+</button></div></div>
                    <div class="stat-row"><span>AGI (Agilidade)</span> <div><span id="val-agi">0</span> <button class="stat-btn" onclick="addStat('agi')">+</button></div></div>
                    <div class="stat-row"><span>VIT (Vitalidade)</span> <div><span id="val-vit">0</span> <button class="stat-btn" onclick="addStat('vit')">+</button></div></div>
                    <div class="stat-row"><span>DES (Destreza)</span> <div><span id="val-dex">0</span> <button class="stat-btn" onclick="addStat('dex')">+</button></div></div>
                    <div class="stat-row"><span>VON (Vontade)</span> <div><span id="val-von">0</span> <button class="stat-btn" onclick="addStat('von')">+</button></div></div>
                    <div class="stat-row"><span>SOR (Sorte)</span> <div><span id="val-sor">0</span> <button class="stat-btn" onclick="addStat('sor')">+</button></div></div>
                </div>
                
                <div class="stat-col" style="border-left: 1px solid #555; padding-left: 15px;">
                    <div style="margin-bottom: 5px;"><strong>COMBATE</strong></div>
                    <div class="stat-row"><span style="color:#e74c3c">ATK (Melee)</span> <span id="val-atk">0</span></div>
                    <div class="stat-row"><span style="color:#e67e22">RATK (Tiro)</span> <span id="val-ratk">0</span></div>
                    <div class="stat-row"><span style="color:#3498db">DEF (Defesa)</span> <span id="val-def">0</span></div>
                    <div class="stat-row"><span style="color:#2ecc71">HIT (Precis√£o)</span> <span id="val-hit">0</span></div>
                    <div class="stat-row"><span style="color:#9b59b6">FLEE (Esquiva)</span> <span id="val-flee">0</span></div>
                    <div class="stat-row"><span style="color:#f1c40f">CRIT (Cr√≠tico)</span> <span id="val-crit">0%</span></div>
                </div>
            </div>
            
            <hr style="border-color: #333;">
            <div style="text-align: center; margin-bottom: 5px; font-size:12px"><strong>EQUIPAMENTO</strong></div>
            <div class="equip-slots">
                <div class="equip-slot" id="slot-head" title="Cabe√ßa"><label>Cabe√ßa</label></div>
                <div class="equip-slot" id="slot-body" title="Corpo"><label>Corpo</label></div>
                <div class="equip-slot" id="slot-hand" title="M√£o"><label>M√£o</label></div>
                <div class="equip-slot" id="slot-legs" title="Pernas"><label>Pernas</label></div>
                <div class="equip-slot" id="slot-feet" title="P√©s"><label>P√©s</label></div>
            </div>

            <div style="text-align: center; margin-top: 15px;">
                <button onclick="toggleStats()" style="padding: 5px 20px;">Fechar</button>
            </div>
        </div>

        <div id="skills-window">
            <div class="skills-header">LIVRO DE HABILIDADES</div>
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('tab-combate', this)">Combate</button>
                <button class="tab-btn" disabled title="Habilidades baseadas em Haki (Indispon√≠vel no momento)">Vontade</button>
                <button class="tab-btn" disabled title="Akuma no Mi e Conquistas (Indispon√≠vel no momento)">Especial</button>
                <button class="tab-btn" disabled title="√Årvores de Classe: Marinha, Pirata... (Indispon√≠vel no momento)">Classes</button>
            </div>
            
            <div id="tab-combate" class="tab-content active">
                <div class="skill-card">
                    <div class="skill-icon">üëä</div>
                    <div class="skill-info">
                        <div class="skill-name">Combate Corpo-a-Corpo</div>
                        <div class="skill-desc">Melhora os danos e combos usando os punhos.</div>
                        <div class="skill-bar-bg"><div class="skill-bar-fill" id="bar-punch"></div></div>
                    </div>
                    <div class="skill-lvl">Lv.<span id="prof-punch">1</span></div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon">ü¶µ</div>
                    <div class="skill-info">
                        <div class="skill-name">Artes Marciais (Chute)</div>
                        <div class="skill-desc">Refina os movimentos e impactos com os p√©s.</div>
                        <div class="skill-bar-bg"><div class="skill-bar-fill" id="bar-kick"></div></div>
                    </div>
                    <div class="skill-lvl">Lv.<span id="prof-kick">1</span></div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon">‚öîÔ∏è</div>
                    <div class="skill-info">
                        <div class="skill-name">Esgrima</div>
                        <div class="skill-desc">Profici√™ncia em ataques cortantes e combos com espadas.</div>
                        <div class="skill-bar-bg"><div class="skill-bar-fill" id="bar-sword"></div></div>
                    </div>
                    <div class="skill-lvl">Lv.<span id="prof-sword">1</span></div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon">üî´</div>
                    <div class="skill-info">
                        <div class="skill-name">Artilharia</div>
                        <div class="skill-desc">Manuseio avan√ßado, aumentando danos com armas de fogo.</div>
                        <div class="skill-bar-bg"><div class="skill-bar-fill" id="bar-gun"></div></div>
                    </div>
                    <div class="skill-lvl">Lv.<span id="prof-gun">1</span></div>
                </div>
            </div>

            <div style="text-align: center; padding: 15px; border-top: 1px solid #444; background: rgba(0,0,0,0.2);">
                <button onclick="toggleSkills()" style="padding: 5px 20px; cursor: pointer;">Fechar</button>
            </div>
        </div>

        <div id="shop-window">
            <div style="text-align: center; border-bottom: 1px solid #e67e22; padding-bottom: 5px; font-weight: bold; color: #e67e22;">
                LOJA DO ARMEIRO
            </div>
            <div id="shop-list" style="overflow-y: auto; max-height: 300px; margin-top: 10px;">
                </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="toggleShop()" style="padding: 5px 15px; cursor: pointer;">Sair</button>
            </div>
        </div>

        <div id="inventory-window">
            <div style="text-align: center; border-bottom: 1px solid #3498db; padding-bottom: 5px; font-weight: bold;">
                MOCHILA (12 Slots)
            </div>
            <div id="inv-grid"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="toggleInventory()" style="padding: 5px 15px; cursor: pointer;">Fechar</button>
            </div>
        </div>

        <div id="notif-area"></div>
        <div id="combat-log">System: RPG Core Active.<br></div>
        <div id="labels-container"></div>
    </div>

    <script src="definitions.js"></script>
    <script src="factory.js"></script>
    <script src="engine.js"></script> 
    <script src="game.js"></script>
</body>
</html>